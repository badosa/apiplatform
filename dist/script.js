class I18n{constructor(){this.translations={},this.currentLang="en",this.supportedLangs=["ca","de","es","en","fr","it","ja","zh"]}async init(e){this.currentLang=this.getInitialLanguage(e),await this.loadTranslations(this.currentLang),this.updateHtmlLang(),this.translatePage()}getInitialLanguage(e){if(e&&this.supportedLangs.includes(e))return localStorage.setItem("preferredLang",e),e;const t=localStorage.getItem("preferredLang");if(t&&this.supportedLangs.includes(t))return t;const n=navigator.language.split("-")[0];return this.supportedLangs.includes(n)?n:"en"}async loadTranslations(e){try{const t=await fetch(`translations/${e}.json`);this.translations=await t.json()}catch(t){console.error(`Failed to load translations for ${e}:`,t),"en"!==e&&await this.loadTranslations("en")}}updateHtmlLang(){document.documentElement.lang=this.currentLang}translate(e){return this.getNestedTranslation(e,this.translations)||e}getNestedTranslation(e,t){return e.split(".").reduce(((e,t)=>e&&e[t]),t)}translatePage(){document.title=this.translate("title"),document.querySelectorAll("[data-i18n]").forEach((e=>{const t=e.getAttribute("data-i18n");e.textContent=this.translate(t)})),document.querySelectorAll("[data-i18n-placeholder]").forEach((e=>{const t=e.getAttribute("data-i18n-placeholder");e.placeholder=this.translate(t)})),document.querySelectorAll("[data-i18n-title]").forEach((e=>{const t=e.getAttribute("data-i18n-title");e.title=this.translate(t)}))}async setLanguage(e){this.supportedLangs.includes(e)&&e!==this.currentLang&&(this.currentLang=e,localStorage.setItem("preferredLang",e),await this.loadTranslations(e),this.updateHtmlLang(),this.translatePage())}}class StreamingHandler{constructor(e){this.messageElement=e,this.contentDiv=e.querySelector(".markdown-content"),this.buffer="",this.messageElement.classList.add("typing"),this.loadingInterval=setInterval((()=>{const e=this.contentDiv.textContent;this.contentDiv.textContent=e.length>=3?".":e+"."}),500)}appendChunk(e){this.loadingInterval&&(clearInterval(this.loadingInterval),this.loadingInterval=null),"<think>"===e?e="[think]\n":"</think>"===e&&(e="\n[/think]"),this.buffer+=e,this.contentDiv.innerHTML=marked.parse(this.buffer),chatMessages.scrollTop=chatMessages.scrollHeight}complete(){this.loadingInterval&&(clearInterval(this.loadingInterval),this.loadingInterval=null),this.buffer&&(modelName.value.startsWith("gemini")||(messageHistory.push({role:"assistant",content:this.buffer}),messageHistory.length>2*MAX_HISTORY&&(messageHistory=messageHistory.slice(2*-MAX_HISTORY)))),this.messageElement.classList.remove("typing"),this.contentDiv.innerHTML=this.contentDiv.innerHTML.replace("<p>[think]</p>",'<details><summary>ðŸ§ </summary><div class="details">').replace("<p>[/think]</p>","</div></details>"),this.contentDiv.innerHTML=this.contentDiv.innerHTML.replace("[think]",'<details><summary>ðŸ§ </summary><div class="details">').replace("[/think]","</div></details>")}}const i18n=new I18n,MAX_HISTORY=5,STORAGE_KEY="llm-chat-settings",SETUP_VISIBLE_KEY="setup-visible",INTRO_VISIBLE_KEY="intro-visible",PROFILES_KEY="llm-chat-profiles",CURRENT_PROFILE_KEY="llm-chat-current-profile";let messageHistory=[],currentController=null;const setupForm=document.getElementById("setup-form"),setupSection=document.getElementById("setup"),toggleSetupButton=document.getElementById("toggle-setup"),clearChatButton=document.getElementById("clear-chat"),endPoint=document.getElementById("endpoint"),modelName=document.getElementById("model-name"),apiKey=document.getElementById("api-key"),temperature=document.getElementById("temperature"),temperatureValue=document.getElementById("temperature-value"),systemPrompt=document.getElementById("system-prompt"),chatMessages=document.getElementById("chat-messages"),userInput=document.getElementById("user-input"),sendButton=document.getElementById("send-message"),stopButton=document.getElementById("stop-generation"),introSection=document.getElementById("intro"),toggleIntroButton=document.getElementById("toggle-intro"),textarea=document.getElementById("user-input"),profileSelector=document.getElementById("profile-selector"),newProfileButton=document.getElementById("new-profile"),deleteProfileButton=document.getElementById("delete-profile");let hasMouse=window.matchMedia("(pointer: fine)").matches;async function loadSettings(){const e=JSON.parse(localStorage.getItem(PROFILES_KEY)||'{"default": {}}')[localStorage.getItem(CURRENT_PROFILE_KEY)||"default"]||{},t="false"!==localStorage.getItem("setup-visible"),n=document.querySelector(".container");endPoint.value=e.endPoint||"",modelName.value=e.modelName||"",apiKey.value=e.apiKey||"",temperature.value=e.temperature||"1.0",temperatureValue.textContent=temperature.value,systemPrompt.value=e.systemPrompt||"",t||(n.classList.add("setup-hidden"),setupSection.style.display="none")}function createMessageElement(e,t=!1,n=!1){const a=document.createElement("div");a.className=`message ${t?"user-message":"assistant-message"} ${n?"error-message":""}`;const s=document.createElement("div");if(s.className="markdown-content",t)s.textContent=e,a.appendChild(s);else{s.innerHTML=marked.parse(e),a.appendChild(s);const t=document.createElement("button");t.className="copy-button",t.title=i18n.translate("chat.copy"),t.innerHTML='\n\t\t\t<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n\t\t\t\t<rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>\n\t\t\t\t<path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>\n\t\t\t</svg>\n\t\t',t.addEventListener("click",(()=>{const e=a.querySelector(".markdown-content"),n=e.textContent||e.innerText;navigator.clipboard.writeText(n).then((()=>{const e=t.innerHTML;t.innerHTML='\n\t\t\t\t\t<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n\t\t\t\t\t\t<path d="M20 6L9 17l-5-5"></path>\n\t\t\t\t\t</svg>\n\t\t\t\t',t.style.background="#10B981",setTimeout((()=>{t.innerHTML=e,t.style.background=""}),2e3)}))})),a.appendChild(t)}return a}function appendMessage(e,t=!1,n=!1){const a=createMessageElement(e,t,n);if(chatMessages.appendChild(a),chatMessages.scrollTop=chatMessages.scrollHeight,n){const t=a.querySelector(".markdown-content"),n=document.createElement("pre");n.textContent=e,t.appendChild(n)}return a}async function isOllamaRunning(e){try{const t=await fetch(e);return"Ollama is running"===await t.text()}catch(e){return console.error("Error checking Ollama status:",e),!1}}async function sendMessage(e){const t={endPoint:endPoint.value.trim(),modelName:modelName.value.trim(),apiKey:apiKey.value.trim(),temperature:temperature.value,systemPrompt:systemPrompt.value.trim()};if(!t.modelName||!t.endPoint&&!t.apiKey)return void window.alert(i18n.translate("errors.unset"));messageHistory.push({role:"user",content:e});const n=appendMessage("",!1);currentController=new AbortController;const a=new StreamingHandler(n);sendButton.classList.add("hidden"),stopButton.classList.remove("hidden");try{if(t.apiKey)if(t.modelName.startsWith("gemini")){const e={systemInstruction:{parts:[{text:t.systemPrompt}]},contents:messageHistory.slice(2*-MAX_HISTORY).map((e=>({role:"assistant"===e.role?"model":"user",parts:[{text:e.content}]}))),generationConfig:{temperature:parseFloat(t.temperature)/2}};try{const n=await fetch(`${t.endPoint}${t.modelName}:streamGenerateContent?key=${t.apiKey}`,{signal:currentController.signal,method:"POST",headers:{"Content-Type":"application/json","User-Agent":"APIplatform.com"},body:JSON.stringify(e)});if(!n.ok){let e=`API Error: ${n.status}`;try{const t=await n.json();e+=` - ${t.error||JSON.stringify(t)}`}catch(t){e+=` - ${await n.text()}`}throw new Error(e)}const s=n.body.getReader(),o=new TextDecoder;return function e(){s.read().then((({done:t,value:n})=>{if(t)return;o.decode(n).split("\n").forEach((e=>{if(e.trim().startsWith('"text": ')){const t=e.trim().replace('"text": "',"").slice(0,-1);a.appendChunk(JSON.parse('"'+t+'"'))}})),e()})).catch((e=>{console.error("Stream reading error:",e)}))}()}catch(e){console.error("Request failed:",e),appendMessage(`Error fetching Gemini response: ${e.message}`,!1,!0)}finally{currentController=null,stopButton.classList.add("hidden"),sendButton.classList.remove("hidden")}}else{const e=await fetch(t.endPoint,{signal:currentController.signal,method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t.apiKey}`,"User-Agent":"APIplatform.com"},body:JSON.stringify({messages:[{role:"system",content:t.systemPrompt},...messageHistory.slice(2*-MAX_HISTORY)],stream:!0,temperature:parseFloat(t.temperature),model:t.modelName})});if(!e.ok){let t=`API Error: ${e.status}`;try{const n=await e.json();t+=` - ${n.error?.message||JSON.stringify(n)}`}catch(n){t+=` - ${await e.text()}`}throw new Error(t)}const n=e.body.getReader(),s=new TextDecoder;for(;;){const{value:e,done:t}=await n.read();if(t)break;const o=s.decode(e).split("\n");for(const e of o)if(e&&"data: [DONE]"!==e&&e.startsWith("data: "))try{const t=JSON.parse(e.slice(6));t.choices?.[0]?.delta?.content&&a.appendChunk(t.choices[0].delta.content)}catch(e){console.error("Error parsing JSON:",e)}}}else{const e=new URL(t.endPoint);if(!await isOllamaRunning(`${e.protocol}//${e.hostname}${e.port?`:${e.port}`:""}`))return void window.alert(i18n.translate("errors.ollama_cors"));const n=(await fetch(`${t.endPoint}`,{signal:currentController.signal,method:"POST",headers:{"Content-Type":"application/json","User-Agent":"APIplatform.com"},body:JSON.stringify({model:t.modelName,messages:[{role:"system",content:t.systemPrompt},...messageHistory.slice(2*-MAX_HISTORY)],stream:!0,temperature:parseFloat(t.temperature)})})).body.getReader(),s=new TextDecoder;for(;;){const{value:e,done:t}=await n.read();if(t)break;const o=s.decode(e).split("\n");for(const e of o)if(e)try{const t=JSON.parse(e);t.message?.content&&a.appendChunk(t.message.content)}catch(e){console.error("Error parsing JSON:",e)}}}}catch(e){a&&!a.messageElement.classList.contains("typing")?appendMessage(`Error: ${e.message}`,!1,!0):a?("AbortError"===e.name?a.appendChunk("\n\n*Generation stopped by user*"):a.appendChunk(`\n\n\`\`\`error\nError during stream: ${e.message}\n\`\`\``),a.complete()):appendMessage(`Unhandled Error: ${e.message}`,!1,!0)}finally{a&&a.messageElement.classList.contains("typing")&&a.complete(),currentController=null,stopButton.classList.add("hidden"),sendButton.classList.remove("hidden")}}function loadProfiles(){const e=JSON.parse(localStorage.getItem(PROFILES_KEY)||'{"default": {}}'),t=localStorage.getItem(CURRENT_PROFILE_KEY)||"default";profileSelector.innerHTML="",Object.keys(e).forEach((e=>{const t=document.createElement("option");t.value=e,t.textContent=e,profileSelector.appendChild(t)})),profileSelector.value=t,loadProfileSettings(t)}function loadProfileSettings(e){const t=JSON.parse(localStorage.getItem(PROFILES_KEY)||'{"default": {}}')[e]||{};endPoint.value=t.endPoint||"",modelName.value=t.modelName||"",apiKey.value=t.apiKey||"",temperature.value=t.temperature||"1.0",temperatureValue.textContent=temperature.value,systemPrompt.value=t.systemPrompt||"",t.language&&(i18n.setLanguage(t.language),document.getElementById("language-selector").value=t.language)}function saveProfileSettings(e){e.preventDefault();const t=profileSelector.value,n=JSON.parse(localStorage.getItem(PROFILES_KEY)||'{"default": {}}');n[t]={endPoint:endPoint.value,modelName:modelName.value,apiKey:apiKey.value,temperature:temperature.value,systemPrompt:systemPrompt.value,language:document.getElementById("language-selector").value},localStorage.setItem(PROFILES_KEY,JSON.stringify(n));const a=document.getElementById("save-settings");a.textContent=i18n.translate("setup.saved"),a.classList.add("saved"),a.disabled=!0,setTimeout((()=>{a.textContent=i18n.translate("setup.save"),a.classList.remove("saved"),a.disabled=!1}),2e3)}function toggleSetup(){const e=document.querySelector(".container"),t=!e.classList.contains("setup-hidden");t?(e.classList.add("setup-hidden"),setupSection.style.display="none"):(e.classList.remove("setup-hidden"),setupSection.style.display="block"),localStorage.setItem("setup-visible",(!t).toString())}function clearChat(){chatMessages.innerHTML="",messageHistory=[]}async function isMacOS(){if(navigator.userAgentData&&"function"==typeof navigator.userAgentData.getHighEntropyValues)try{const e=await navigator.userAgentData.getHighEntropyValues(["platform"]);if(e.platform)return"macos"===e.platform.toLowerCase()}catch(e){}return!!navigator.platform&&navigator.platform.toUpperCase().indexOf("MAC")>=0}window.matchMedia("(pointer: fine)").addEventListener("change",(e=>{hasMouse=e.matches,document.body.classList.toggle("has-mouse",hasMouse)})),document.body.classList.toggle("has-mouse",hasMouse),document.querySelector(".setup-close").addEventListener("click",toggleSetup),document.querySelectorAll(".clear-input").forEach((e=>{e.addEventListener("click",(e=>{const t=e.target.parentElement.querySelector("input");t.value="",t.focus()}))})),window.addEventListener("load",loadSettings),document.addEventListener("DOMContentLoaded",(async()=>{const e=await isMacOS(),t=navigator.maxTouchPoints>0&&window.innerWidth<=768;sendButton.setAttribute("data-i18n-title",e?"chat.buttons.sendTitleMac":"chat.buttons.sendTitlePC"),textarea.setAttribute("data-i18n-placeholder",t?"chat.userInput.placeholder":e?"chat.userInput.placeholderMac":"chat.userInput.placeholderPC");const n=new URLSearchParams(window.location.search);await i18n.init(n.get("lang"));const a=document.getElementById("language-selector");a.value=i18n.currentLang,loadLanguageContent(i18n.currentLang),a.addEventListener("change",(e=>{const t=e.target.value;i18n.setLanguage(t),loadLanguageContent(t)})),textarea.addEventListener("input",(function(){this.style.height="auto",this.style.height=`${this.scrollHeight}px`})),temperature.addEventListener("input",(()=>{temperatureValue.textContent=temperature.value})),toggleSetupButton.addEventListener("click",toggleSetup),clearChatButton.addEventListener("click",clearChat),stopButton.addEventListener("click",(()=>{currentController&&(currentController.abort(),currentController=null),stopButton.classList.add("hidden"),sendButton.classList.remove("hidden")})),sendButton.addEventListener("click",(()=>{const e=userInput.value.trim();e&&(appendMessage(e,!0),userInput.value="",sendMessage(e))})),userInput.addEventListener("keydown",(e=>{"Enter"===e.key&&(e.ctrlKey||e.metaKey)&&(e.preventDefault(),sendButton.click())}));setIntroVisibility("false"!==localStorage.getItem("intro-visible")),toggleIntroButton.addEventListener("click",(()=>{setIntroVisibility(!(!1===introSection.classList.contains("hidden")))})),loadProfiles(),profileSelector.addEventListener("change",(e=>{const t=e.target.value;localStorage.setItem(CURRENT_PROFILE_KEY,t),loadProfileSettings(t)})),newProfileButton.addEventListener("click",(()=>{const e=prompt(i18n.translate("setup.newProfile"))?.trim();if(e){const t=JSON.parse(localStorage.getItem(PROFILES_KEY)||'{"default": {}}');if(t[e])return void alert(i18n.translate("setup.profileExists"));t[e]={},localStorage.setItem(PROFILES_KEY,JSON.stringify(t)),localStorage.setItem(CURRENT_PROFILE_KEY,e),loadProfiles()}})),deleteProfileButton.addEventListener("click",(()=>{const e=profileSelector.value;if("default"!==e){if(confirm(`${i18n.translate("setup.confirm")} "${e}"?`)){const t=JSON.parse(localStorage.getItem(PROFILES_KEY));delete t[e],localStorage.setItem(PROFILES_KEY,JSON.stringify(t)),localStorage.setItem(CURRENT_PROFILE_KEY,"default"),loadProfiles()}}else alert(i18n.translate("setup.cannotDelete"))})),setupForm.addEventListener("submit",saveProfileSettings)}));const toggleTrashVisibility=()=>{clearChatButton.style.display=chatMessages.children.length>0?"flex":"none"};toggleTrashVisibility();const observer=new MutationObserver(toggleTrashVisibility);async function loadLanguageContent(e){try{const t=await fetch(`/translations/${e}.html`);if(!t.ok)throw new Error(`Content not found for ${e}`);const n=await t.text();introSection.innerHTML=n;setIntroVisibility("false"!==localStorage.getItem("intro-visible"))}catch(t){console.error("Error loading intro:",t),introSection.innerHTML=`<p class="error-message">Failed to load introduction for ${e}.</p>`}}function setIntroVisibility(e){e?(introSection.classList.remove("hidden"),toggleIntroButton.setAttribute("aria-expanded","true"),toggleIntroButton.classList.remove("collapsed"),localStorage.setItem("intro-visible","true")):(introSection.classList.add("hidden"),toggleIntroButton.setAttribute("aria-expanded","false"),toggleIntroButton.classList.add("collapsed"),localStorage.setItem("intro-visible","false"))}observer.observe(chatMessages,{childList:!0}),sendButton.classList.remove("hidden"),stopButton.classList.add("hidden");